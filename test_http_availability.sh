#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è HTTP –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —á–µ—Ä–µ–∑ –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤—â–∏–∫
# –ê–≤—Ç–æ—Ä: Terraform HA Infrastructure Project

echo "=== –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ HTTP –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —á–µ—Ä–µ–∑ –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤—â–∏–∫ ==="
echo "–î–∞—Ç–∞: $(date)"
echo

# –ü–æ–ª—É—á–∞–µ–º –ø—É–±–ª–∏—á–Ω—ã–π IP –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤—â–∏–∫–∞
NLB_IP=$(terraform output -raw nlb_public_ip)
echo "–ü—É–±–ª–∏—á–Ω—ã–π IP –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤—â–∏–∫–∞: $NLB_IP"
echo

# –¢–µ—Å—Ç 1: –ë–∞–∑–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏
echo "1. –ë–∞–∑–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ HTTP –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏:"
HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://$NLB_IP)
RESPONSE_TIME=$(curl -s -o /dev/null -w "%{time_total}" http://$NLB_IP)

if [ "$HTTP_STATUS" = "200" ]; then
    echo "‚úÖ HTTP Status: $HTTP_STATUS (OK)"
    echo "‚è±Ô∏è  Response Time: ${RESPONSE_TIME}s"
else
    echo "‚ùå HTTP Status: $HTTP_STATUS (FAILED)"
    exit 1
fi
echo

# –¢–µ—Å—Ç 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
echo "2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ –¥–µ—Ñ–æ–ª—Ç–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã Nginx:"
CONTENT=$(curl -s http://$NLB_IP)
if echo "$CONTENT" | grep -q "Nginx Server:"; then
    echo "‚úÖ –°—Ç—Ä–∞–Ω–∏—Ü–∞ —Å–æ–¥–µ—Ä–∂–∏—Ç –æ–∂–∏–¥–∞–µ–º—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç Nginx"
    echo "üìÑ –°–æ–¥–µ—Ä–∂–∏–º–æ–µ: $(echo "$CONTENT" | grep "Nginx Server:")"
else
    echo "‚ùå –°—Ç—Ä–∞–Ω–∏—Ü–∞ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –æ–∂–∏–¥–∞–µ–º—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç Nginx"
    echo "üìÑ –ü–æ–ª—É—á–µ–Ω–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ: $CONTENT"
fi
echo

# –¢–µ—Å—Ç 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏ –Ω–∞–≥—Ä—É–∑–∫–∏
echo "3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏ –Ω–∞–≥—Ä—É–∑–∫–∏ (10 –∑–∞–ø—Ä–æ—Å–æ–≤):"
declare -A servers
for i in {1..10}; do
    SERVER=$(curl -s http://$NLB_IP | grep -o 'Server: [^<]*' | cut -d' ' -f2)
    servers["$SERVER"]=$((${servers["$SERVER"]} + 1))
    sleep 0.5
done

echo "–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–æ —Å–µ—Ä–≤–µ—Ä–∞–º:"
for server in "${!servers[@]}"; do
    echo "  üñ•Ô∏è  $server: ${servers[$server]} –∑–∞–ø—Ä–æ—Å–æ–≤"
done

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –±–æ–ª–µ–µ –æ–¥–Ω–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞
if [ ${#servers[@]} -gt 1 ]; then
    echo "‚úÖ –ë–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è ${#servers[@]} —Å–µ—Ä–≤–µ—Ä–∞)"
else
    echo "‚ö†Ô∏è  –í–Ω–∏–º–∞–Ω–∏–µ: –≤—Å–µ –∑–∞–ø—Ä–æ—Å—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Å–µ—Ä–≤–µ—Ä"
fi
echo

# –¢–µ—Å—Ç 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ HTTP
echo "4. –ü—Ä–æ–≤–µ—Ä–∫–∞ HTTP –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤:"
curl -s -I http://$NLB_IP | head -5
echo

echo "=== –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ ==="
echo "–í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ! –ë–∞–ª–∞–Ω—Å–∏—Ä–æ–≤—â–∏–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ."